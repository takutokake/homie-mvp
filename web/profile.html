<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete Your Profile - Homie</title>
    <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
    <style>
        :root {
            --homie-orange: #FDAA25;
            --homie-violet: #CE7AFF;
        }
        .bg-grid {
            background-size: 40px 40px;
            background-image: 
                linear-gradient(to right, rgba(255,255,255,.05) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(255,255,255,.05) 1px, transparent 1px);
        }
        .glowing-dot {
            width: 4px;
            height: 4px;
            background: var(--homie-orange);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(253, 170, 37, 0.6);
            animation: glow 4s infinite;
        }
        @keyframes glow {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
    </style>
        <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        'homie-orange': '#FDAA25',
                        'homie-violet': '#CE7AFF'
                    }
                }
            }
        }
    </script>
    <link as="style" href="https://fonts.googleapis.com/css2?display=swap&amp;family=Inter%3Awght%40400%3B500%3B700%3B900&amp;family=Noto+Sans%3Awght%40400%3B500%3B700%3B900" onload="this.rel='stylesheet'" rel="stylesheet"/>
    <title>Homie - Complete Profile</title>
    <link href="data:image/x-icon;base64," rel="icon" type="image/x-icon"/>
    <script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
    <style type="text/tailwindcss">
        :root {
            --homie-orange: #FDAA25;
            --homie-violet: #CE7AFF;
            --violet-glow: 0 0 10px rgba(206, 122, 255, 0.5), 0 0 20px rgba(206, 122, 255, 0.3);
            --orange-glow: 0 0 15px rgba(253, 170, 37, 0.6), 0 0 30px rgba(253, 170, 37, 0.4);
            --orange-glow-strong: 0 0 25px rgba(253, 170, 37, 0.8), 0 0 50px rgba(253, 170, 37, 0.6);
        }
        @keyframes glow-shift {
            0% {
                box-shadow: var(--violet-glow);
                border-color: #CE7AFF;
            }
            100% {
                box-shadow: var(--orange-glow);
                border-color: #FDAA25;
            }
        }
        .form-input:focus {
            caret-color: #FDAA25;
            animation: glow-shift 0.5s forwards;
        }
        .primary-cta {
            box-shadow: var(--orange-glow);
            transition: transform 0.3s ease-in-out, box-shadow 0.3s ease-in-out;
        }
        .primary-cta:hover {
            transform: scale(1.05);
            box-shadow: var(--orange-glow-strong);
        }
        .primary-cta:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        .bg-grid {
            background-image:
                linear-gradient(to right, rgba(253, 170, 37, 0.1) 1px, transparent 1px),
                linear-gradient(to bottom, rgba(253, 170, 37, 0.1) 1px, transparent 1px);
            background-size: 40px 40px;
        }
        @keyframes pulse-dots {
            0%, 100% {
                opacity: 0.2;
                transform: scale(0.8);
            }
            50% {
                opacity: 0.6;
                transform: scale(1.2);
            }
        }
        .glowing-dot {
            width: 4px;
            height: 4px;
            background-color: #FDAA25;
            border-radius: 50%;
            box-shadow: 0 0 8px #FDAA25, 0 0 12px #FDAA25;
            animation: pulse-dots 4s infinite ease-in-out;
        }
        .glowing-dot:nth-child(1) { animation-delay: 0s; }
        .glowing-dot:nth-child(2) { animation-delay: 1s; }
        .glowing-dot:nth-child(3) { animation-delay: 2s; }
        .glowing-dot:nth-child(4) { animation-delay: 3s; }
        .glowing-dot:nth-child(5) { animation-delay: 0.5s; }
        .glowing-dot:nth-child(6) { animation-delay: 1.5s; }
        .glowing-dot:nth-child(7) { animation-delay: 2.5s; }
        .glowing-dot:nth-child(8) { animation-delay: 3.5s; }
    </style>
</head>
<body class="bg-[#1C160C]">
    <div class="relative flex size-full min-h-screen flex-col bg-[#1C160C] dark group/design-root overflow-hidden" style='font-family: Inter, "Noto Sans", sans-serif;'>
        <div class="absolute inset-0 z-0 bg-grid opacity-50"></div>
        <div class="absolute inset-0 z-0">
            <div class="glowing-dot absolute top-[10%] left-[20%]"></div>
            <div class="glowing-dot absolute top-[20%] left-[80%]"></div>
            <div class="glowing-dot absolute top-[50%] left-[50%]"></div>
            <div class="glowing-dot absolute top-[80%] left-[10%]"></div>
            <div class="glowing-dot absolute top-[90%] left-[90%]"></div>
            <div class="glowing-dot absolute top-[30%] left-[5%]"></div>
            <div class="glowing-dot absolute top-[60%] left-[95%]"></div>
            <div class="glowing-dot absolute top-[5%] left-[60%]"></div>
        </div>
        <div class="relative z-10 layout-container flex h-full grow flex-col">
            <header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-b-[#4A3C21] px-10 py-3">
                <div class="flex items-center gap-4 text-white">
                    <img src="assets/images/homie-logo.png" alt="Homie Logo" class="h-10 w-10"/>
                    <h1 class="text-white text-2xl font-bold leading-tight tracking-[-0.015em]">Homie</h1>
                </div>
            </header>
            <main class="flex flex-1 items-center justify-center py-16 px-4">
                <div class="w-full max-w-2xl space-y-8">
                    <div class="text-center">
                        <h2 class="text-3xl font-bold text-white">Complete Your Profile</h2>
                        <p class="mt-2 text-gray-400">Tell us about yourself to find your perfect homies.</p>
                    </div>
                    
                    <form id="profile-form" class="space-y-8 bg-[#231C10]/80 backdrop-blur-sm rounded-xl border border-[#4A3C21] p-8">
                    <!-- Personal Information Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-[#4A3C21] pb-2">Personal Information</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="display_name" class="block text-sm font-medium text-gray-300 mb-2">Display Name *</label>
                                <input type="text" id="display_name" name="display_name" required
                                       placeholder="Name shown to other users"
                                       class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white placeholder:text-gray-500 focus:ring-[#FDAA25] transition-all duration-300">
                            </div>
                            
                            <div>
                                <label for="phone_number" class="block text-sm font-medium text-gray-300 mb-2">Phone Number</label>
                                <input type="tel" id="phone_number" name="phone_number"
                                       placeholder="(555) 123-4567"
                                       class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white placeholder:text-gray-500 focus:ring-[#FDAA25] transition-all duration-300">
                            </div>
                        </div>
                        
                        <div class="flex items-center space-x-3">
                            <input type="checkbox" id="sms_consent" name="sms_consent"
                                   class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                            <label for="sms_consent" class="text-sm text-gray-300">I consent to receive SMS notifications about meetups</label>
                        </div>
                    </div>

                    <!-- School Information Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-[#4A3C21] pb-2">School Information</h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <div>
                                <label for="school" class="block text-sm font-medium text-gray-300 mb-2">School *</label>
                                <select id="school" name="school" required
                                        class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white focus:ring-[#FDAA25] transition-all duration-300">
                                    <option value="">Select your school</option>
                                    <option value="USC">USC</option>
                                    <option value="UCLA">UCLA</option>
                                </select>
                            </div>
                            
                            <div>
                                <label for="school_area" class="block text-sm font-medium text-gray-300 mb-2">School Area</label>
                                <input type="text" id="school_area" name="school_area"
                                       placeholder="Dorm, Area, etc."
                                       class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white placeholder:text-gray-500 focus:ring-[#FDAA25] transition-all duration-300">
                            </div>
                        </div>
                    </div>

                    <!-- Preferences Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-[#4A3C21] pb-2">Your Preferences</h3>
                        
                        <div>
                            <label for="price_range" class="block text-sm font-medium text-gray-300 mb-2">Budget Range *</label>
                            <select id="price_range" name="price_range" required
                                    class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white focus:ring-[#FDAA25] transition-all duration-300">
                                <option value="">Select your budget range</option>
                                <option value="$">$ - Budget friendly ($0-15)</option>
                                <option value="$$">$$ - Moderate ($15-30)</option>
                                <option value="$$$">$$$ - Higher end ($30-50)</option>
                                <option value="$$$$">$$$$ - Premium ($50+)</option>
                            </select>
                        </div>

                        <!-- Meeting Preferences -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">Meeting Preferences *</label>
                            <div class="grid grid-cols-2 md:grid-cols-3 gap-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="coffee" 
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">☕ Coffee</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="food"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🍽️ Food</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="study"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">📚 Study</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="activity"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🎯 Activity</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="social"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🎉 Social</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="meeting_preference" value="outdoor"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🌳 Outdoor</span>
                                </label>
                            </div>
                        </div>

                        <!-- Interests -->
                        <div>
                            <label for="interests" class="block text-sm font-medium text-gray-300 mb-2">Interests *</label>
                            <input class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white placeholder:text-gray-500 focus:ring-[#FDAA25] transition-all duration-300" 
                                   id="interests" name="interests" 
                                   placeholder="e.g., music, sports, art, gaming, cooking..."
                                   required
                                   type="text"/>
                        </div>

                        <!-- Hangout Types -->
                        <div>
                            <label for="hangoutTypes" class="block text-sm font-medium text-gray-300 mb-2">Preferred Hangout Types *</label>
                            <input class="form-input w-full rounded-lg border border-[#4A3C21] bg-[#231C10] px-4 py-3 text-white placeholder:text-gray-500 focus:ring-[#FDAA25] transition-all duration-300" 
                                   id="hangoutTypes" name="hangoutTypes" 
                                   placeholder="e.g., cafe, restaurant, park, library, gym..."
                                   required
                                   type="text"/>
                        </div>
                    </div>

                    <!-- Availability Section -->
                    <div class="space-y-6">
                        <h3 class="text-lg font-semibold text-white border-b border-[#4A3C21] pb-2">When You're Available</h3>
                        
                        <!-- Preferred Time of Day -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">Preferred Time of Day *</label>
                            <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_time_of_day" value="morning" 
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🌅 Morning</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_time_of_day" value="afternoon"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">☀️ Afternoon</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_time_of_day" value="evening"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🌆 Evening</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_time_of_day" value="night"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🌙 Night</span>
                                </label>
                            </div>
                        </div>

                        <!-- Preferred Days -->
                        <div>
                            <label class="block text-sm font-medium text-gray-300 mb-3">Preferred Days *</label>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_days" value="weekdays" 
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">📅 Weekdays (Mon-Fri)</span>
                                </label>
                                <label class="flex items-center space-x-3 p-3 rounded-lg border border-[#4A3C21] hover:border-[#FDAA25] transition-colors cursor-pointer">
                                    <input type="checkbox" name="preferred_days" value="weekends"
                                           class="rounded border-[#4A3C21] bg-[#231C10] text-[#FDAA25] focus:ring-[#FDAA25]">
                                    <span class="text-sm text-gray-300">🎉 Weekends (Sat-Sun)</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <!-- Submit Button -->
                    <div class="pt-4">
                        <button type="submit" id="submit-btn"
                                class="primary-cta w-full rounded-lg bg-[#FDAA25] px-6 py-4 text-lg font-bold text-black hover:bg-[#fbc256] transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-[#FDAA25] focus:ring-offset-2 focus:ring-offset-[#1C160C]">
                            Complete Profile
                        </button>
                    </div>
                </form>
                </div>
            </main>
</div>
</div>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script>
    // Initialize Supabase directly with credentials
    const supabase = window.supabase.createClient(
        'https://cfmegjvcnsbuyiwvmzft.supabase.co',
        'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNmbWVnanZjbnNidXlpd3ZtemZ0Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY4NzgzNDUsImV4cCI6MjA3MjQ1NDM0NX0.8d2PW5KY1vP2AsYHWUxmHYZydvl5hToanYX8YQV8QgM'
    );

    async function initSupabase() {
        try {
            console.log('=== PROFILE PAGE INITIALIZATION START ===');
            console.log('Profile page: URL:', window.location.href);
            console.log('Profile page: Checking session...');
            
            const { data: { session }, error } = await supabase.auth.getSession();
            console.log('Profile page: Session check result:', { 
                hasSession: !!session, 
                sessionId: session?.user?.id,
                sessionEmail: session?.user?.email,
                error: error 
            });
            
            if (error) {
                console.error('Profile page: Session error:', error);
                window.location.href = 'login.html';
                return;
            }
            
            if (!session) {
                console.log('Profile page: No session found, redirecting to login');
                window.location.href = 'login.html';
                return;
            }
            
            console.log('Profile page: Valid session found for user:', session.user.id);
            console.log('Profile page: Session expires at:', new Date(session.expires_at * 1000));

            // Check if user exists in users table and if profile is completed
            const { data: user, error: userError } = await supabase
                .from('users')
                .select('*')
                .eq('id', session.user.id)
                .single();

            // If user has completed profile, redirect to success page
            if (user && user.profile_completed && user.display_name) {
                console.log('Profile already completed, redirecting to success page');
                window.location.href = 'profile-success.html';
                return;
            }

            if (userError || !user) {
                console.log('User not found in database, creating profile...');
                // Create user profile if it doesn't exist
                try {
                    await supabase.from('users').insert([{
                        id: session.user.id,
                        email: session.user.email,
                        username: session.user.email.split('@')[0],
                        display_name: '',
                        phone_number: '',
                        profile_completed: false,
                        created_at: new Date().toISOString(),
                        last_login: new Date().toISOString()
                    }]);
                    console.log('User profile created successfully');
                } catch (insertError) {
                    console.error('Failed to create user profile:', insertError);
                    // Don't redirect, let user try to complete profile anyway
                }
            }
        } catch (error) {
            console.error('Profile page: Failed to initialize:', error);
            console.log('Profile page: Staying on page despite initialization error');
            // Don't redirect on initialization errors, let user stay on profile page
        }
        
        console.log('=== PROFILE PAGE INITIALIZATION COMPLETE ===');
    }

    async function handleSubmit(event) {
        event.preventDefault();
        const submitButton = document.getElementById('submit-btn');
        submitButton.disabled = true;
        submitButton.textContent = 'Saving...';

        try {
            const { data: { session }, error: sessionError } = await supabase.auth.getSession();
            if (sessionError || !session) throw new Error('No active session');

            // Skip username validation - not needed

            // Safe form value getters
            const getFormValue = (id) => {
                const element = document.getElementById(id);
                return element ? element.value.trim() : '';
            };

            const getCheckedValues = (name) => {
                return Array.from(document.querySelectorAll(`input[name="${name}"]:checked`)).map(cb => cb.value);
            };

            const formData = {
                id: session.user.id,
                email: session.user.email,
                display_name: getFormValue('display_name'),
                phone_number: getFormValue('phone_number'),
                sms_consent: document.getElementById('sms_consent')?.checked || false,
                school: getFormValue('school'),
                location_details: getFormValue('school_area'),
                price_range: getFormValue('price_range'),
                meeting_preference: getCheckedValues('meeting_preference'),
                interests: getFormValue('interests').split(',').map(i => i.trim()).filter(i => i),
                cuisine_preferences: getFormValue('hangoutTypes').split(',').map(i => i.trim()).filter(i => i),
                profile_completed: true,
                updated_at: new Date().toISOString()
            };

            console.log('Submitting profile data:', formData);

            // Update user profile
            const { data: updateData, error: updateError } = await supabase
                .from('users')
                .upsert(formData)
                .select()
                .single();

            if (updateError) throw updateError;
            console.log('Profile saved successfully:', updateData);

            // Skip old invite code generation - we use referral_chain now
            console.log('Skipping old invite code generation - using referral_chain system');

            // Generate referral code for the new user
            try {
                console.log('Generating referral code for user:', session.user.id);
                const referredByCode = localStorage.getItem('homie_invite');
                const { data: referralCode, error: referralError } = await supabase
                    .rpc('generate_user_referral_code', {
                        p_user_id: session.user.id,
                        p_referred_by_code: referredByCode
                    });
                
                if (referralError) {
                    console.error('Error generating referral code:', referralError);
                    throw referralError;
                }
                
                console.log('Generated referral code:', referralCode);
                localStorage.setItem('homie_generated_invite', referralCode);
                
            } catch (error) {
                console.error('Failed to generate referral code:', error);
                // Generate fallback 6-character code
                const chars = 'ABCDEFGHJKLMNPQRSTUVWXYZ23456789';
                let fallbackCode = '';
                for (let i = 0; i < 6; i++) {
                    fallbackCode += chars.charAt(Math.floor(Math.random() * chars.length));
                }
                console.log('Using fallback code:', fallbackCode);
                localStorage.setItem('homie_generated_invite', fallbackCode);
            }
            
            // Store school for success page
            localStorage.setItem('homie_school', formData.school);

            // Redirect to success page
            window.location.href = 'profile-success.html';

        } catch (error) {
            console.error('Error saving profile:', error);
            alert(error.message || 'Failed to save profile');
        } finally {
            submitButton.disabled = false;
            submitButton.textContent = 'Complete Profile';
        }
    }
    
    // Check if we have user info from signup in localStorage
    const storedUser = localStorage.getItem('homie_user');
    if (storedUser) {
        console.log('Found stored user from signup:', JSON.parse(storedUser));
    }
    
    // Wait for session to be established, then initialize
    setTimeout(initSupabase, 500);
    document.getElementById('profile-form').addEventListener('submit', handleSubmit);
</script>
</body>
</html>
